<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Players</title>
  <style>
    :root { --bg:#0b0f19; --card:#11182a; --muted:#93a4c7; --text:#e7eeff; --line:#23314f; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    header { padding:24px 16px 12px; border-bottom:1px solid var(--line); position:sticky; top:0; background:rgba(11,15,25,.92); backdrop-filter: blur(10px); z-index:10; }
    .wrap { max-width:1200px; margin:0 auto; }
    h1 { margin:0 0 10px; font-size:20px; letter-spacing:.3px; }
    .sub { color:var(--muted); font-size:13px; }
    .toolbar { display:flex; flex-wrap:wrap; gap:10px; margin-top:14px; align-items:center; }
    .tabs { display:flex; gap:8px; flex-wrap:wrap; }
    .tab {
      border:1px solid var(--line); background:transparent; color:var(--text);
      padding:8px 10px; border-radius:10px; cursor:pointer; font-size:13px;
    }
    .tab.active { background:var(--card); border-color:#36508a; }
    .search, select {
      border:1px solid var(--line); background:var(--card); color:var(--text);
      padding:9px 10px; border-radius:10px; font-size:13px; outline:none;
    }
    .search { min-width:240px; flex:1; }
    main { padding:16px; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; }
    .meta { display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; margin-bottom:10px; }
    .pill { font-size:12px; color:var(--muted); }
    .status { font-size:12px; color:var(--muted); }
    .table-wrap { overflow:auto; border-radius:12px; border:1px solid var(--line); }
    table { width:100%; border-collapse:collapse; min-width:900px; }
    th, td { padding:10px 10px; border-bottom:1px solid var(--line); font-size:13px; white-space:nowrap; }
    th { position:sticky; top:0; background:#0f1730; cursor:pointer; user-select:none; text-align:left; }
    th .arrow { opacity:.7; margin-left:6px; }
    tr:hover td { background:rgba(255,255,255,.03); }
    .muted { color:var(--muted); }
    .right { text-align:right; }
    .empty { padding:18px; color:var(--muted); font-size:13px; }
    footer { padding:16px; color:var(--muted); font-size:12px; text-align:center; }
    code { color:#cfe0ff; }

    .player-link { cursor:pointer; color:#cfe0ff; font-weight:800; }
    .player-link:hover { text-decoration: underline; }

    /* modal */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.65);
      display:none; align-items:center; justify-content:center; padding:16px; z-index:100;
    }
    .modal{
      width:min(1040px, 100%);
      background:linear-gradient(180deg,#121b31 0%, #0f1730 100%);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
      overflow:hidden;
    }
    .modal-header{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--line);
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
    }
    .modal-title{
      display:flex; flex-direction:column; gap:6px;
    }
    .modal-title .name{ font-size:18px; font-weight:900; letter-spacing:.2px; }
    .modal-title .subline{ font-size:12px; color:var(--muted); }
    .modal-actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{ background:rgba(255,255,255,.07); }
    .btn.primary{ border-color:#36508a; background:rgba(54,80,138,.25); }
    .modal-body{ padding:14px; display:grid; gap:12px; }

    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 920px){
      .grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    .statbox{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px;
    }
    .statbox .label{ font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.8px; }
    .statbox .value{ margin-top:6px; font-size:18px; font-weight:900; }

    .section{
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      border-radius:14px;
      padding:12px;
    }
    .section h3{ margin:0 0 10px; font-size:13px; color:#dbe7ff; letter-spacing:.2px; }
    .tag { font-size:12px; color:var(--muted); }

    .small-table { min-width: 0; width:100%; border-collapse:collapse; }
    .small-table th, .small-table td { padding:8px 8px; border-bottom:1px solid rgba(255,255,255,.08); font-size:13px; }
    .small-table th { background:rgba(255,255,255,.03); position:static; cursor:default; }
    .small-table tr:last-child td { border-bottom:none; }

    .filters { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .filters .muted { font-size:13px; }
    /* ================================
   Mobile layout improvements
   ================================ */
@media (max-width: 820px) {
  header { padding: 16px 12px 10px; }

  .toolbar { gap: 8px; }
  .tabs { width: 100%; }
  .tab { flex: 1; text-align: center; }

  #filters { width: 100%; flex-wrap: wrap; }
  #filters select { flex: 1; min-width: 0; }

  .search { width: 100%; min-width: 0; order: 50; }
  #limit { width: 100%; }

  .modal { width: 100%; height: 92vh; }
  .modal-body { overflow: auto; max-height: calc(92vh - 70px); }
}

/* Sticky first column (player) on mobile */
@media (max-width: 820px) {
  table { min-width: 760px; }

  th:first-child, td:first-child {
    position: sticky;
    left: 0;
    z-index: 2;
    background: #0f1730;
  }

  td:first-child {
    background: rgba(17,24,42,1);
    z-index: 1;
  }
}

  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>PLAYERS</h1>
      
      <div class="toolbar">
        <div class="tabs">
          <button class="tab active" data-dataset="players">Players</button>
          <button class="tab" data-dataset="regular">Regular season</button>
          <button class="tab" data-dataset="playoffs">Playoffs</button>
        </div>

        <div class="filters" id="filters" style="display:none;">
          <label class="muted">Season</label>
          <select id="seasonFilter"></select>

          <label class="muted">Division</label>
          <select id="divisionFilter"></select>
        </div>

        <input id="search" class="search" placeholder="Search Player" />

        <label class="muted" style="font-size:13px;">Show</label>
        <select id="limit">
          <option value="50">50 rows</option>
          <option value="100" selected>100 rows</option>
          <option value="250">250 rows</option>
          <option value="1000">1000 rows</option>
          <option value="999999">Alles</option>
        </select>

        <span id="status" class="status">Loading…</span>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="card">
        <div class="meta">
          <div class="pill" id="metaLeft">—</div>
          <div class="pill" id="metaRight">—</div>
        </div>

        <div class="table-wrap">
          <table id="table">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div id="empty" class="empty" style="display:none;">Geen resultaten.</div>
      </div>
    </div>
  </main>

  <footer>
    <div class="wrap">
      Powered by GitHub Pages • Data: <code>site/data/*.json</code>
    </div>
  </footer>

  <!-- Player modal -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">
          <div class="name" id="mName">Player</div>
          <div class="subline" id="mSub">—</div>
        </div>
        <div class="modal-actions">
          <button class="btn primary" id="mClose">Close</button>
        </div>
      </div>
      <div class="modal-body" id="mBody"></div>
    </div>
  </div>

  <script>
    const FILES = {
      players: "site/data/players.json",
      regular: "site/data/stats_regular.json",
      playoffs: "site/data/stats_playoffs.json",
    };

    // Division mapping
    const DIVISION_LABELS = {
      "1": "Euromillions League",
      "2": "HSE - 1e Landelijke",
      "3": "HSE - 2e Landelijke A",
      "4": "HSE - 2e Landelijke B",
      "5": "HSE - 1P Antwerpen",
      "6": "HSE - 1P Limburg",
      "7": "HSE - 1P Oost-Vlaanderen",
      "8": "HSE - 1P Vlaams-Brabant",
      "9": "HSE - 1P West-Vlaanderen",
      "10": "Top Division Men 1",
      "11": "Top Division Men 2A",
      "12": "Top Division Men 2B",
      "13": "BNXT League",
      "14": "HSE - Régional 1",
      "15": "HSE - Régional 2A",
      "16": "HSE - Régional 2B",
      "17": "Play-offs TDM1",
      "18": "Play-offs TDM2",
      "19": "Top Division Women 1",
      "20": "DSE - 1e Landelijke",
      "21": "DSE - 2e Landelijke A",
      "22": "DSE - 2e Landelijke B",
      "23": "DSE - 1P Antwerpen",
      "24": "DSE - 1P Limburg",
      "25": "DSE - 1P Oost-Vlaanderen",
      "26": "DSE - 1P Vlaams-Brabant",
      "27": "DSE- 1P West-Vlaanderen",
      "28": "Play-Offs TDW1",
      "29": "DSE - Régional 1",
      "30": "DSE - Régional 2A",
      "31": "DSE - Régional 2B",
    };

    // Column order per tab (JSON keys!)
    const COLUMN_ORDER = {
      players: ["full_name","birth_date","height","country","position"],
      regular: ["player_name","season_name","division_name","gp","pts","min","reb","ast","stl","blk","to","fls","twopm","twopa","threepm","threepa","ftm","fta","slug"],
      playoffs: ["player_name","season_name","division_name","gp","pts","min","reb","ast","stl","blk","to","fls","twopm","twopa","threepm","threepa","ftm","fta","slug"],
    };

    // Column labels (headers)
    const COLUMN_LABELS = {
      player_name: "player",
      full_name: "player",
      birth_date: "birth",
      height: "height",
      country: "country",
      position: "position",
      player_id: "player_id",
      season_name: "season",
      division_name: "division",
      gp: "gp",
      pts: "pts",
      ppg: "ppg",
      min: "min",
      reb: "reb",
      rpg: "rpg",
      ast: "ast",
      apg: "apg",
      stl: "stl",
      spg: "spg",
      to: "to",
      blk: "blk",
      bpg: "bpg",
      fls: "fls",
      twopm: "2pm",
      twopa: "2pa",
      threepm: "3pm",
      threepa: "3pa",
      ftm: "ftm",
      fta: "fta",
      slug: "slug",
    };

    const state = {
      active: "players",
      raw: { players: null, regular: null, playoffs: null },
      rows: [],
      cols: [],
      sortKey: null,
      sortDir: "desc",
      search: "",
      limit: 100,
      filterSeason: "",
      filterDivision: "",
      idxPlayersBySlug: new Map(),
      idxRegularBySlug: new Map(),
      idxPlayoffsBySlug: new Map(),
      modal: { open:false, slug:null }
    };

    const el = {
      tabs: Array.from(document.querySelectorAll(".tab")),
      search: document.getElementById("search"),
      limit: document.getElementById("limit"),
      thead: document.getElementById("thead"),
      tbody: document.getElementById("tbody"),
      empty: document.getElementById("empty"),
      status: document.getElementById("status"),
      metaLeft: document.getElementById("metaLeft"),
      metaRight: document.getElementById("metaRight"),
      filters: document.getElementById("filters"),
      seasonFilter: document.getElementById("seasonFilter"),
      divisionFilter: document.getElementById("divisionFilter"),
      modalBackdrop: document.getElementById("modalBackdrop"),
      mName: document.getElementById("mName"),
      mSub: document.getElementById("mSub"),
      mBody: document.getElementById("mBody"),
      mClose: document.getElementById("mClose"),
    };

    function isNumberLike(v) {
      if (v === null || v === undefined) return false;
      if (typeof v === "number") return Number.isFinite(v);
      if (typeof v === "string") {
        const s = v.trim().replace(",", ".");
        if (s === "") return false;
        const n = Number(s);
        return Number.isFinite(n);
      }
      return false;
    }
    function toNumber(v) {
      if (typeof v === "number") return v;
      if (typeof v === "string") return Number(v.trim().replace(",", "."));
      return NaN;
    }
    function safeNum(x){ const n = toNumber(x); return Number.isFinite(n) ? n : 0; }
    function pct(m,a){
      const mm = safeNum(m), aa = safeNum(a);
      if (aa <= 0) return "—";
      return (mm/aa*100).toFixed(1) + "%";
    }
    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function normalizeToRows(data) {
      if (Array.isArray(data)) return data;
      if (data && Array.isArray(data.data)) return data.data;
      if (data && typeof data === "object") {
        const vals = Object.values(data);
        if (vals.every(v => typeof v === "object")) return vals;
      }
      return [];
    }
    async function loadJson(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`${url} -> HTTP ${res.status}`);
      return await res.json();
    }
    async function ensureDatasetLoaded(key) {
      if (state.raw[key]) return;
      el.status.textContent = `Loading ${key}…`;
      state.raw[key] = await loadJson(FILES[key]);
    }

    function labelForDivision(div) {
      if (div === null || div === undefined) return "";
      const key = String(div);
      return DIVISION_LABELS[key] || key;
    }
    function headerLabel(col) { return COLUMN_LABELS[col] || col; }

    function formatCell(col, v) {
      if (v === null || v === undefined) return "";
      if (col === "division_name") return labelForDivision(v);
      return String(v);
    }

    function pickColumnsForActive(rows, active) {
      const forced = COLUMN_ORDER[active];
       if (forced && forced.length) return forced;

    // fallback: toon alles als er geen order is
      const existing = new Set();
        for (const r of rows) if (r && typeof r === "object") Object.keys(r).forEach(k => existing.add(k));
        return Array.from(existing);
    }


    function getSearchHaystack(row) {
      if (!row || typeof row !== "object") return "";
      return Object.entries(row).map(([k,v]) => {
        if (k === "division_name") return labelForDivision(v);
        if (v === null || v === undefined) return "";
        if (typeof v === "object") return JSON.stringify(v);
        return String(v);
      }).join(" ").toLowerCase();
    }

    function rowMatchesFilters(r) {
      // filters only for stats tabs
      if (!(state.active === "regular" || state.active === "playoffs")) return true;

      if (state.filterSeason && String(r?.season_name ?? "") !== state.filterSeason) return false;

      if (state.filterDivision) {
        const raw = String(r?.division_name ?? "");
        // accept match by raw code OR by label (handy)
        const lbl = labelForDivision(raw);
        if (raw !== state.filterDivision && lbl !== state.filterDivision) return false;
      }

      return true;
    }

    function applySearchLimitSort() {
      let rows = state.rows;

      // Filters first
      rows = rows.filter(rowMatchesFilters);

      // Search
      const q = state.search.trim().toLowerCase();
      if (q) rows = rows.filter(r => getSearchHaystack(r).includes(q));

      // Sort
      if (state.sortKey) {
        const k = state.sortKey;
        const dir = state.sortDir === "asc" ? 1 : -1;

        rows = rows.slice().sort((a,b) => {
          let av = a?.[k];
          let bv = b?.[k];
          if (k === "division_name") { av = labelForDivision(av); bv = labelForDivision(bv); }

          const an = isNumberLike(av);
          const bn = isNumberLike(bv);
          if (an && bn) return (toNumber(av) - toNumber(bv)) * dir;

          const as = av === null || av === undefined ? "" : String(av);
          const bs = bv === null || bv === undefined ? "" : String(bv);
          return as.localeCompare(bs, "nl", { numeric: true, sensitivity: "base" }) * dir;
        });
      }

      // Limit
      return rows.slice(0, state.limit);
    }

    function buildIndexes() {
      state.idxPlayersBySlug.clear();
      const players = normalizeToRows(state.raw.players);
      for (const p of players) {
        const slug = p?.slug;
        if (typeof slug === "string" && slug) state.idxPlayersBySlug.set(slug, p);
      }

      function fill(map, rows) {
        map.clear();
        for (const r of rows) {
          const slug = r?.slug;
          if (typeof slug !== "string" || !slug) continue;
          if (!map.has(slug)) map.set(slug, []);
          map.get(slug).push(r);
        }
      }
      fill(state.idxRegularBySlug, normalizeToRows(state.raw.regular));
      fill(state.idxPlayoffsBySlug, normalizeToRows(state.raw.playoffs));
    }

    function enrichStatsWithPlayerNames() {
      function enrich(key) {
        const rows = normalizeToRows(state.raw[key]);
        for (const r of rows) {
          const slug = r?.slug;
          const p = (typeof slug === "string") ? state.idxPlayersBySlug.get(slug) : null;
          r.player_name = p?.full_name || slug || "";
        }
      }
      enrich("regular");
      enrich("playoffs");
    }

    function populateFiltersFromRows(rows) {
      // only stats tabs show filters
      const isStats = state.active === "regular" || state.active === "playoffs";
      el.filters.style.display = "flex";
      if (!isStats) return;

      const seasons = new Set();
      const divisionsRaw = new Set();

      for (const r of rows) {
        if (r?.season_name) seasons.add(String(r.season_name));
        if (r?.division_name !== undefined && r?.division_name !== null) divisionsRaw.add(String(r.division_name));
      }

      const seasonList = Array.from(seasons).sort((a,b) => b.localeCompare(a, "nl", { numeric:true }));
      const divisionList = Array.from(divisionsRaw).sort((a,b) => labelForDivision(a).localeCompare(labelForDivision(b), "nl", { numeric:true }));

      // Build season select
      el.seasonFilter.innerHTML = `<option value="">All seasons</option>` + seasonList.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");
      // keep selection if still valid
      if (state.filterSeason && seasonList.includes(state.filterSeason)) el.seasonFilter.value = state.filterSeason;
      else { state.filterSeason = ""; el.seasonFilter.value = ""; }

      // Build division select: store raw code as value, show label
      el.divisionFilter.innerHTML = `<option value="">All divisions</option>` + divisionList.map(d => {
        const lbl = labelForDivision(d);
        return `<option value="${escapeHtml(d)}">${escapeHtml(lbl)}</option>`;
      }).join("");

      if (state.filterDivision && divisionList.includes(state.filterDivision)) el.divisionFilter.value = state.filterDivision;
      else { state.filterDivision = ""; el.divisionFilter.value = ""; }
    }

    function openPlayerModal(slug) {
      if (!slug) return;
      state.modal.open = true;
      state.modal.slug = slug;
      renderPlayerModal();
      el.modalBackdrop.style.display = "flex";
      el.modalBackdrop.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    }

    function closeModal() {
      state.modal.open = false;
      state.modal.slug = null;
      el.modalBackdrop.style.display = "none";
      el.modalBackdrop.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    }

    function renderStatsTable(title, rows) {
      if (!rows || rows.length === 0) {
        return `<div class="section"><h3>${escapeHtml(title)}</h3><div class="tag">Geen data.</div></div>`;
      }

      const cols = ["season_name","division_name","gp","min","pts","reb","ast","stl","blk","to","fls","twopm","twopa","threepm","threepa","ftm","fta"]
        .filter(c => rows.some(r => r?.[c] !== undefined));

      const head = cols.map(c => `<th>${escapeHtml(headerLabel(c))}</th>`).join("");
      const body = rows.map(r => {
        const tds = cols.map(c => {
          const v = formatCell(c, r?.[c]);
          const cls = isNumberLike(r?.[c]) ? "right" : "";
          return `<td class="${cls}">${escapeHtml(v)}</td>`;
        }).join("");
        return `<tr>${tds}</tr>`;
      }).join("");

      const sum = (key) => rows.reduce((acc,r) => acc + safeNum(r?.[key]), 0);
      const gp = sum("gp"), pts = sum("pts"), reb = sum("reb"), ast = sum("ast"), min = sum("min");
      const twopm = sum("twopm"), twopa = sum("twopa");
      const threepm = sum("threepm"), threepa = sum("threepa");
      const ftm = sum("ftm"), fta = sum("fta");
      const fgm = twopm + threepm;
      const fga = twopa + threepa;

      return `
        <div class="section">
          <h3>${escapeHtml(title)}</h3>

          <div class="grid" style="margin-bottom:10px;">
            <div class="statbox"><div class="label">GP</div><div class="value">${gp}</div></div>
            <div class="statbox"><div class="label">PTS</div><div class="value">${pts}</div></div>
            <div class="statbox"><div class="label">REB</div><div class="value">${reb}</div></div>
            <div class="statbox"><div class="label">AST</div><div class="value">${ast}</div></div>
          </div>

          <div class="tag" style="margin-bottom:10px;">
            MIN: <b>${min}</b> • 2P: <b>${twopm}/${twopa}</b> (${pct(twopm,twopa)}) •
            3P: <b>${threepm}/${threepa}</b> (${pct(threepm,threepa)}) •
            FT: <b>${ftm}/${fta}</b> (${pct(ftm,fta)}) •
            FG: <b>${fgm}/${fga}</b> (${pct(fgm,fga)})
          </div>

          <div class="table-wrap" style="border-radius:12px;">
            <table class="small-table">
              <thead><tr>${head}</tr></thead>
              <tbody>${body}</tbody>
            </table>
          </div>
        </div>
      `;
    }

    function renderPlayerModal() {
      const slug = state.modal.slug;

      const player = state.idxPlayersBySlug.get(slug) || null;
      const regularRows = state.idxRegularBySlug.get(slug) || [];
      const playoffsRows = state.idxPlayoffsBySlug.get(slug) || [];

      const fullName = player?.full_name || slug;
      const birth = player?.birth_date || "—";
      const pid = player?.player_id ?? "—";
      const height = (player?.height ?? "—");
      const country = (player?.country ?? "—");
      const position = (player?.position ?? "—");

      el.mName.textContent = fullName;
      el.mSub.textContent = `slug: ${slug} • player_id: ${pid}`;

      el.mBody.innerHTML = `
        <div class="section">
          <h3>Player info</h3>
          <div class="tag">
            Birth: <b>${escapeHtml(String(birth))}</b> •
            Height: <b>${escapeHtml(String(height))}</b> •
            Country: <b>${escapeHtml(String(country))}</b> •
            Position: <b>${escapeHtml(String(position))}</b>
          </div>
        </div>

        ${renderStatsTable("Regular season", regularRows)}
        ${renderStatsTable("Playoffs", playoffsRows)}

        <div class="section">
          <h3>Awards (later)</h3>
          <div class="tag">Placeholder: MVP, All-Star, Topscorer, …</div>
        </div>
      `;
    }

    function render() {
      const shown = applySearchLimitSort();

      el.metaLeft.textContent = `Dataset: ${state.active}`;
      el.metaRight.textContent = `Totaal rijen: ${state.rows.length} • Na filters/zoek: ${shown.length} • Sort: ${state.sortKey ?? "—"} (${state.sortDir})`;

      el.empty.style.display = shown.length ? "none" : "block";

      const ths = state.cols.map(col => {
        const arrow = state.sortKey === col ? (state.sortDir === "asc" ? "▲" : "▼") : "↕";
        return `<th data-col="${escapeHtml(col)}">${escapeHtml(headerLabel(col))}<span class="arrow">${arrow}</span></th>`;
      }).join("");

      el.thead.innerHTML = `<tr>${ths}</tr>`;

      const isPlayersTab = state.active === "players";
      const isStatsTab = state.active === "regular" || state.active === "playoffs";

      const rowsHtml = shown.map(r => {
        const tds = state.cols.map(col => {
          const rawVal = r?.[col];
          const cls = isNumberLike(rawVal) ? "right" : "";

          // clickable player cells
          if (isPlayersTab && (col === "full_name" || col === "slug")) {
            const slug = r?.slug;
            if (typeof slug === "string" && slug) {
              return `<td class="${cls}"><span class="player-link" data-slug="${escapeHtml(slug)}">${escapeHtml(formatCell(col, rawVal))}</span></td>`;
            }
          }

          if (isStatsTab && col === "player_name") {
            const slug = r?.slug;
            if (typeof slug === "string" && slug) {
              return `<td class="${cls}"><span class="player-link" data-slug="${escapeHtml(slug)}">${escapeHtml(formatCell(col, rawVal))}</span></td>`;
            }
          }

          if (isStatsTab && col === "slug") {
            const slug = rawVal;
            if (typeof slug === "string" && slug) {
              return `<td class="${cls}"><span class="player-link" data-slug="${escapeHtml(slug)}">${escapeHtml(formatCell(col, rawVal))}</span></td>`;
            }
          }

          return `<td class="${cls}">${escapeHtml(formatCell(col, rawVal))}</td>`;
        }).join("");
        return `<tr>${tds}</tr>`;
      }).join("");

      el.tbody.innerHTML = rowsHtml;

      // sort click
      el.thead.querySelectorAll("th").forEach(th => {
        th.addEventListener("click", () => {
          const col = th.getAttribute("data-col");
          if (state.sortKey === col) state.sortDir = state.sortDir === "asc" ? "desc" : "asc";
          else { state.sortKey = col; state.sortDir = "desc"; }
          render();
        });
      });

      // player click -> modal
      el.tbody.querySelectorAll(".player-link").forEach(span => {
        span.addEventListener("click", () => openPlayerModal(span.getAttribute("data-slug")));
      });
    }

    async function setActive(key) {
      state.active = key;
      el.tabs.forEach(t => t.classList.toggle("active", t.dataset.dataset === key));

      await ensureDatasetLoaded(key);

      const rows = normalizeToRows(state.raw[key]);
      state.rows = rows;
      state.cols = pickColumnsForActive(rows, key);

      populateFiltersFromRows(rows);

      // default sort
      if (key === "players") {
        state.sortKey = state.cols.includes("full_name") ? "full_name" : (state.cols[0] ?? null);
        state.sortDir = "asc";
      } else {
        if (state.cols.includes("pts")) { state.sortKey = "pts"; state.sortDir = "desc"; }
        else if (state.cols.includes("season_name")) { state.sortKey = "season_name"; state.sortDir = "desc"; }
        else { state.sortKey = state.cols[0] ?? null; state.sortDir = "desc"; }
      }

      el.status.textContent = `OK • ${rows.length} rijen geladen`;
      render();
    }

    // Events
    el.tabs.forEach(btn => btn.addEventListener("click", () => setActive(btn.dataset.dataset)));
    el.search.addEventListener("input", (e) => { state.search = e.target.value; render(); });
    el.limit.addEventListener("change", (e) => { state.limit = Number(e.target.value); render(); });

    el.seasonFilter.addEventListener("change", (e) => { state.filterSeason = e.target.value; render(); });
    el.divisionFilter.addEventListener("change", (e) => { state.filterDivision = e.target.value; render(); });

    el.mClose.addEventListener("click", closeModal);
    el.modalBackdrop.addEventListener("click", (e) => { if (e.target === el.modalBackdrop) closeModal(); });
    window.addEventListener("keydown", (e) => { if (e.key === "Escape" && state.modal.open) closeModal(); });

    // Boot
    (async function init() {
      try {
        await ensureDatasetLoaded("players");
        await ensureDatasetLoaded("regular");
        await ensureDatasetLoaded("playoffs");
        buildIndexes();
        enrichStatsWithPlayerNames();
        await setActive("players");
      } catch (e) {
        console.error(e);
        el.status.textContent = "Fout bij laden van JSON.";
      }
    })();
  </script>
</body>
</html>
