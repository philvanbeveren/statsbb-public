<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StatsBasketballBelgium — Stats</title>
  <style>
    :root { --bg:#0b0f19; --card:#11182a; --muted:#93a4c7; --text:#e7eeff; --line:#23314f; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    header { padding:24px 16px 12px; border-bottom:1px solid var(--line); position:sticky; top:0; background:rgba(11,15,25,.92); backdrop-filter: blur(10px); z-index:10; }
    .wrap { max-width:1200px; margin:0 auto; }
    h1 { margin:0 0 10px; font-size:20px; letter-spacing:.3px; }
    .sub { color:var(--muted); font-size:13px; }
    .toolbar { display:flex; flex-wrap:wrap; gap:10px; margin-top:14px; align-items:center; }
    .tabs { display:flex; gap:8px; flex-wrap:wrap; }
    .tab {
      border:1px solid var(--line); background:transparent; color:var(--text);
      padding:8px 10px; border-radius:10px; cursor:pointer; font-size:13px;
    }
    .tab.active { background:var(--card); border-color:#36508a; }
    .search, select {
      border:1px solid var(--line); background:var(--card); color:var(--text);
      padding:9px 10px; border-radius:10px; font-size:13px; outline:none;
    }
    .search { min-width:260px; flex:1; }
    main { padding:16px; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; }
    .meta { display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; margin-bottom:10px; }
    .pill { font-size:12px; color:var(--muted); }
    .status { font-size:12px; color:var(--muted); }
    .table-wrap { overflow:auto; border-radius:12px; border:1px solid var(--line); }
    table { width:100%; border-collapse:collapse; min-width:900px; }
    th, td { padding:10px 10px; border-bottom:1px solid var(--line); font-size:13px; white-space:nowrap; }
    th { position:sticky; top:0; background:#0f1730; cursor:pointer; user-select:none; text-align:left; }
    th .arrow { opacity:.7; margin-left:6px; }
    tr:hover td { background:rgba(255,255,255,.03); }
    .muted { color:var(--muted); }
    .right { text-align:right; }
    .empty { padding:18px; color:var(--muted); font-size:13px; }
    footer { padding:16px; color:var(--muted); font-size:12px; text-align:center; }
    a { color:#9bb8ff; text-decoration:none; }
    a:hover { text-decoration:underline; }

    /* clickable player cell */
    .player-link { cursor:pointer; color:#cfe0ff; font-weight:600; }
    .player-link:hover { text-decoration: underline; }

    /* modal */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.65);
      display:none; align-items:center; justify-content:center; padding:16px; z-index:100;
    }
    .modal{
      width:min(920px, 100%);
      background:linear-gradient(180deg,#121b31 0%, #0f1730 100%);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
      overflow:hidden;
    }
    .modal-header{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--line);
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .modal-title{
      display:flex; flex-direction:column; gap:2px;
    }
    .modal-title .name{ font-size:16px; font-weight:800; letter-spacing:.2px; }
    .modal-title .subline{ font-size:12px; color:var(--muted); }
    .modal-actions{ display:flex; gap:8px; align-items:center; }
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{ background:rgba(255,255,255,.07); }
    .btn.primary{ border-color:#36508a; background:rgba(54,80,138,.25); }
    .modal-body{ padding:14px; display:grid; gap:12px; }
    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 820px){
      .grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    .statbox{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px;
    }
    .statbox .label{ font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.8px; }
    .statbox .value{ margin-top:6px; font-size:18px; font-weight:800; }
    .two-col{
      display:grid; grid-template-columns: 1.2fr .8fr; gap:12px;
    }
    @media (max-width: 820px){
      .two-col{ grid-template-columns: 1fr; }
    }
    .section{
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      border-radius:14px;
      padding:12px;
    }
    .section h3{ margin:0 0 10px; font-size:13px; color:#dbe7ff; letter-spacing:.2px; }
    .kv{ display:grid; grid-template-columns: 1fr auto; gap:8px; }
    .kv div{ padding:6px 0; border-bottom:1px solid rgba(255,255,255,.06); font-size:13px; }
    .kv div:nth-last-child(-n+2){ border-bottom:none; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>StatsBasketballBelgium — Stats Dashboard</h1>
      <div class="sub">Leest JSON uit <code>site/data/</code> (players + stats). Tabs, zoeken, sorteren. Klik op speler voor details.</div>

      <div class="toolbar">
        <div class="tabs">
          <button class="tab active" data-dataset="players">Players</button>
          <button class="tab" data-dataset="regular">Regular season</button>
          <button class="tab" data-dataset="playoffs">Playoffs</button>
        </div>

        <input id="search" class="search" placeholder="Zoek op naam, club, ID… (live)" />

        <label class="muted" style="font-size:13px;">Toon</label>
        <select id="limit">
          <option value="50">50 rijen</option>
          <option value="100" selected>100 rijen</option>
          <option value="250">250 rijen</option>
          <option value="1000">1000 rijen</option>
          <option value="999999">Alles</option>
        </select>

        <span id="status" class="status">Loading…</span>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="card">
        <div class="meta">
          <div class="pill" id="metaLeft">—</div>
          <div class="pill" id="metaRight">—</div>
        </div>

        <div class="table-wrap">
          <table id="table">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div id="empty" class="empty" style="display:none;">Geen resultaten.</div>
      </div>
    </div>
  </main>

  <footer>
    <div class="wrap">
      Powered by GitHub Pages • Data: <code>site/data/*.json</code>
    </div>
  </footer>

  <!-- Player modal -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">
          <div class="name" id="mName">Player</div>
          <div class="subline" id="mSub">—</div>
        </div>
        <div class="modal-actions">
          <button class="btn" id="mToggle">Show playoffs</button>
          <button class="btn primary" id="mOpenProfile">Open profile</button>
          <button class="btn" id="mClose">Close</button>
        </div>
      </div>
      <div class="modal-body" id="mBody"></div>
    </div>
  </div>

  <script>
    const FILES = {
      players: "site/data/players.json",
      regular: "site/data/stats_regular.json",
      playoffs: "site/data/stats_playoffs.json",
    };

    // If you want clicks to go to your real website, set this:
    // const PROFILE_BASE = "https://www.statsbasketballbelgium.be/players/";
    const PROFILE_BASE = null; // null -> stays on GitHub Pages (no external link base)

    const state = {
      active: "players",
      raw: { players: null, regular: null, playoffs: null },
      rows: [],
      cols: [],
      sortKey: null,
      sortDir: "desc",
      search: "",
      limit: 100,
      // modal
      modal: {
        open: false,
        slug: null,
        mode: "regular", // or "playoffs"
      }
    };

    const el = {
      tabs: Array.from(document.querySelectorAll(".tab")),
      search: document.getElementById("search"),
      limit: document.getElementById("limit"),
      thead: document.getElementById("thead"),
      tbody: document.getElementById("tbody"),
      empty: document.getElementById("empty"),
      status: document.getElementById("status"),
      metaLeft: document.getElementById("metaLeft"),
      metaRight: document.getElementById("metaRight"),
      // modal
      modalBackdrop: document.getElementById("modalBackdrop"),
      mName: document.getElementById("mName"),
      mSub: document.getElementById("mSub"),
      mBody: document.getElementById("mBody"),
      mClose: document.getElementById("mClose"),
      mToggle: document.getElementById("mToggle"),
      mOpenProfile: document.getElementById("mOpenProfile"),
    };

    function isNumberLike(v) {
      if (v === null || v === undefined) return false;
      if (typeof v === "number") return Number.isFinite(v);
      if (typeof v === "string") {
        const s = v.trim().replace(",", ".");
        if (s === "") return false;
        const n = Number(s);
        return Number.isFinite(n);
      }
      return false;
    }

    function toNumber(v) {
      if (typeof v === "number") return v;
      if (typeof v === "string") return Number(v.trim().replace(",", "."));
      return NaN;
    }

    function formatCell(v) {
      if (v === null || v === undefined) return "";
      if (typeof v === "object") return JSON.stringify(v);
      return String(v);
    }

    function detectColumns(rows) {
      const keySet = new Map();
      for (const r of rows) {
        if (!r || typeof r !== "object") continue;
        for (const k of Object.keys(r)) {
          if (!keySet.has(k)) keySet.set(k, 0);
          keySet.set(k, keySet.get(k) + 1);
        }
      }
      const keys = Array.from(keySet.entries())
        .sort((a,b) => b[1]-a[1] || a[0].localeCompare(b[0]))
        .map(([k]) => k);

      const preferred = ["full_name", "name", "player_name", "player", "slug", "player_id", "season_name", "division_name", "team",
                         "gp","pts","min","reb","ast","stl","to","blk","fls","twopm","twopa","threepm","threepa","ftm","fta"];
      const front = [];
      const rest = [];
      for (const k of keys) {
        if (preferred.includes(k)) front.push(k);
        else rest.push(k);
      }
      return [...front, ...rest];
    }

    function getSearchHaystack(row) {
      if (!row || typeof row !== "object") return "";
      return Object.values(row).map(v => {
        if (v === null || v === undefined) return "";
        if (typeof v === "object") return JSON.stringify(v);
        return String(v);
      }).join(" ").toLowerCase();
    }

    function applySearchLimitSort() {
      let rows = state.rows;

      const q = state.search.trim().toLowerCase();
      if (q) rows = rows.filter(r => getSearchHaystack(r).includes(q));

      if (state.sortKey) {
        const k = state.sortKey;
        const dir = state.sortDir === "asc" ? 1 : -1;

        rows = rows.slice().sort((a,b) => {
          const av = a?.[k];
          const bv = b?.[k];

          const an = isNumberLike(av);
          const bn = isNumberLike(bv);

          if (an && bn) return (toNumber(av) - toNumber(bv)) * dir;

          const as = av === null || av === undefined ? "" : String(av);
          const bs = bv === null || bv === undefined ? "" : String(bv);
          return as.localeCompare(bs, "nl", { numeric: true, sensitivity: "base" }) * dir;
        });
      }

      rows = rows.slice(0, state.limit);
      return rows;
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function loadJson(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`${url} -> HTTP ${res.status}`);
      return await res.json();
    }

    function normalizeToRows(data) {
      if (Array.isArray(data)) return data;
      if (data && Array.isArray(data.data)) return data.data;
      if (data && typeof data === "object") {
        const vals = Object.values(data);
        if (vals.every(v => typeof v === "object")) return vals;
      }
      return [];
    }

    async function ensureDatasetLoaded(key) {
      if (state.raw[key]) return;
      el.status.textContent = `Loading ${key}…`;
      const data = await loadJson(FILES[key]);
      state.raw[key] = data;
    }

    function guessPlayerName(row) {
      return row?.full_name ?? row?.player_name ?? row?.name ?? row?.player ?? row?.slug ?? "Player";
    }

    function openModalForSlug(slug) {
      if (!slug) return;

      state.modal.open = true;
      state.modal.slug = slug;
      // default: use current tab (regular/playoffs), but if on players tab => regular
      if (state.active === "playoffs") state.modal.mode = "playoffs";
      else state.modal.mode = "regular";

      renderModal();
      el.modalBackdrop.style.display = "flex";
      el.modalBackdrop.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    }

    function closeModal() {
      state.modal.open = false;
      state.modal.slug = null;
      el.modalBackdrop.style.display = "none";
      el.modalBackdrop.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    }

    function pct(m, a) {
      const mm = toNumber(m), aa = toNumber(a);
      if (!Number.isFinite(mm) || !Number.isFinite(aa) || aa <= 0) return "—";
      return (mm / aa * 100).toFixed(1) + "%";
    }

    function safe(n) {
      const x = toNumber(n);
      return Number.isFinite(x) ? x : 0;
    }

    function findStatRow(mode, slug) {
      const key = mode === "playoffs" ? "playoffs" : "regular";
      const rows = normalizeToRows(state.raw[key]);
      // We assume per (slug, season, division) there may be multiple entries, but for v2 we show the first match.
      return rows.find(r => r?.slug === slug) || null;
    }

    function renderModal() {
      const slug = state.modal.slug;
      const mode = state.modal.mode;

      const statRow = findStatRow(mode, slug);
      const otherRow = findStatRow(mode === "regular" ? "playoffs" : "regular", slug);

      const name = statRow ? guessPlayerName(statRow) : slug;
      const season = statRow?.season_name ?? "—";
      const division = statRow?.division_name ?? "—";

      el.mName.textContent = name;
      el.mSub.textContent = `slug: ${slug} • season: ${season} • division: ${division} • view: ${mode}`;

      // toggle button text + enable if other exists
      const hasOther = !!otherRow;
      el.mToggle.textContent = mode === "regular" ? "Show playoffs" : "Show regular";
      el.mToggle.style.opacity = hasOther ? "1" : ".45";
      el.mToggle.style.pointerEvents = hasOther ? "auto" : "none";

      // Open profile button
      el.mOpenProfile.onclick = () => {
        const url = PROFILE_BASE ? (PROFILE_BASE + encodeURIComponent(slug)) : (location.origin + location.pathname.replace(/\/$/, "") + "/#player=" + encodeURIComponent(slug));
        window.open(url, "_blank");
      };

      if (!statRow) {
        el.mBody.innerHTML = `
          <div class="section">
            <h3>Geen stats gevonden</h3>
            <div class="muted">Ik vond geen record met slug <code>${escapeHtml(slug)}</code> in <code>${mode}</code>.</div>
          </div>
        `;
        return;
      }

      // compute shooting
      const twopm = safe(statRow.twopm), twopa = safe(statRow.twopa);
      const threepm = safe(statRow.threepm), threepa = safe(statRow.threepa);
      const ftm = safe(statRow.ftm), fta = safe(statRow.fta);
      const fgm = twopm + threepm;
      const fga = twopa + threepa;

      const gp = safe(statRow.gp);
      const pts = safe(statRow.pts);
      const min = safe(statRow.min);
      const reb = safe(statRow.reb);
      const ast = safe(statRow.ast);
      const stl = safe(statRow.stl);
      const tov = safe(statRow.to);
      const blk = safe(statRow.blk);
      const fls = safe(statRow.fls);

      const ppg = gp > 0 ? (pts / gp).toFixed(2) : "—";
      const rpg = gp > 0 ? (reb / gp).toFixed(2) : "—";
      const apg = gp > 0 ? (ast / gp).toFixed(2) : "—";

      el.mBody.innerHTML = `
        <div class="grid">
          <div class="statbox"><div class="label">PTS</div><div class="value">${pts}</div></div>
          <div class="statbox"><div class="label">GP</div><div class="value">${gp}</div></div>
          <div class="statbox"><div class="label">MIN</div><div class="value">${min}</div></div>
          <div class="statbox"><div class="label">REB</div><div class="value">${reb}</div></div>

          <div class="statbox"><div class="label">AST</div><div class="value">${ast}</div></div>
          <div class="statbox"><div class="label">STL</div><div class="value">${stl}</div></div>
          <div class="statbox"><div class="label">TO</div><div class="value">${tov}</div></div>
          <div class="statbox"><div class="label">BLK</div><div class="value">${blk}</div></div>
        </div>

        <div class="two-col">
          <div class="section">
            <h3>Per game</h3>
            <div class="kv">
              <div>PPG</div><div><b>${ppg}</b></div>
              <div>RPG</div><div><b>${rpg}</b></div>
              <div>APG</div><div><b>${apg}</b></div>
            </div>
          </div>

          <div class="section">
            <h3>Discipline</h3>
            <div class="kv">
              <div>Fouls</div><div><b>${fls}</b></div>
              <div>Turnovers</div><div><b>${tov}</b></div>
            </div>
          </div>
        </div>

        <div class="section">
          <h3>Shooting</h3>
          <div class="kv">
            <div>2PT</div><div><b>${twopm}/${twopa}</b> <span class="muted">(${pct(twopm, twopa)})</span></div>
            <div>3PT</div><div><b>${threepm}/${threepa}</b> <span class="muted">(${pct(threepm, threepa)})</span></div>
            <div>FT</div><div><b>${ftm}/${fta}</b> <span class="muted">(${pct(ftm, fta)})</span></div>
            <div>FG</div><div><b>${fgm}/${fga}</b> <span class="muted">(${pct(fgm, fga)})</span></div>
          </div>
        </div>
      `;
    }

    function render() {
      const shown = applySearchLimitSort();

      el.metaLeft.textContent = `Dataset: ${state.active}`;
      el.metaRight.textContent = `Totaal rijen: ${state.rows.length} • Getoond: ${shown.length} • Sort: ${state.sortKey ?? "—"} (${state.sortDir})`;

      el.empty.style.display = shown.length ? "none" : "block";

      const ths = state.cols.map(col => {
        const arrow = state.sortKey === col ? (state.sortDir === "asc" ? "▲" : "▼") : "↕";
        return `<th data-col="${escapeHtml(col)}">${escapeHtml(col)}<span class="arrow">${arrow}</span></th>`;
      }).join("");

      el.thead.innerHTML = `<tr>${ths}</tr>`;

      // Build body with clickable player cell for stats tabs
      const isStatsTab = state.active === "regular" || state.active === "playoffs";

      const rowsHtml = shown.map(r => {
        const tds = state.cols.map(col => {
          const v = r?.[col];
          const cls = isNumberLike(v) ? "right" : "";

          // Make the "slug" or "full_name/player_name/name" clickable
          if (isStatsTab) {
            const nameKey = ["full_name","player_name","name","player"].find(k => state.cols.includes(k)) || null;

            if (col === "slug" && typeof v === "string" && v.trim() !== "") {
              return `<td class="${cls}"><span class="player-link" data-slug="${escapeHtml(v)}">${escapeHtml(v)}</span></td>`;
            }

            if (nameKey && col === nameKey) {
              const slug = r?.slug;
              if (typeof slug === "string" && slug.trim() !== "") {
                return `<td class="${cls}"><span class="player-link" data-slug="${escapeHtml(slug)}">${escapeHtml(formatCell(v))}</span></td>`;
              }
            }
          }

          return `<td class="${cls}">${escapeHtml(formatCell(v))}</td>`;
        }).join("");
        return `<tr>${tds}</tr>`;
      }).join("");

      el.tbody.innerHTML = rowsHtml;

      // Sort click
      el.thead.querySelectorAll("th").forEach(th => {
        th.addEventListener("click", () => {
          const col = th.getAttribute("data-col");
          if (state.sortKey === col) state.sortDir = state.sortDir === "asc" ? "desc" : "asc";
          else { state.sortKey = col; state.sortDir = "desc"; }
          render();
        });
      });

      // Player click -> modal
      el.tbody.querySelectorAll(".player-link").forEach(span => {
        span.addEventListener("click", () => openModalForSlug(span.getAttribute("data-slug")));
      });
    }

    async function setActive(key) {
      state.active = key;
      el.tabs.forEach(t => t.classList.toggle("active", t.dataset.dataset === key));

      await ensureDatasetLoaded(key);

      const rows = normalizeToRows(state.raw[key]);
      state.rows = rows;
      state.cols = detectColumns(rows);

      const numericCol = state.cols.find(c => rows.some(r => isNumberLike(r?.[c])));
      state.sortKey = numericCol ?? state.cols[0] ?? null;
      state.sortDir = numericCol ? "desc" : "asc";

      el.status.textContent = `OK • ${rows.length} rijen geladen`;
      render();
    }

    // Events
    el.tabs.forEach(btn => btn.addEventListener("click", () => setActive(btn.dataset.dataset)));

    el.search.addEventListener("input", (e) => {
      state.search = e.target.value;
      render();
    });

    el.limit.addEventListener("change", (e) => {
      state.limit = Number(e.target.value);
      render();
    });

    // Modal events
    el.mClose.addEventListener("click", closeModal);
    el.modalBackdrop.addEventListener("click", (e) => {
      if (e.target === el.modalBackdrop) closeModal();
    });
    el.mToggle.addEventListener("click", async () => {
      // ensure other dataset loaded
      const nextMode = state.modal.mode === "regular" ? "playoffs" : "regular";
      await ensureDatasetLoaded(nextMode);
      state.modal.mode = nextMode;
      renderModal();
    });
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && state.modal.open) closeModal();
    });

    // Boot
    (async function init() {
      try {
        await ensureDatasetLoaded("regular");
        await ensureDatasetLoaded("playoffs");
        await ensureDatasetLoaded("players");
        await setActive("players");
      } catch (e) {
        console.error(e);
        el.status.textContent = "Fout bij laden van JSON.";
      }
    })();
  </script>
</body>
</html>
